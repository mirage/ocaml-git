<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>S (git-http.Git_http__.Sync.S)</title><link rel="stylesheet" href="../../../../odoc.css"/><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="generator" content="doc-ock-html v1.0.0-1-g1fc9bf0"/></head><body><nav id="top"><a href="../index.html">Up</a> &mdash; <span class="package">package <a href="../../../index.html">git-http</a></span></nav><header><h1><span class="keyword">Module type</span> <span class="module-path">Git_http__.Sync.S</span></h1></header><div class="spec module" id="module-Web"><a href="#module-Web" class="anchor"></a><div class="def module"><code><span class="keyword">module </span><a href="Web/index.html">Web</a> : <a href="../../../Git_http/Web/index.html#module-type-S">Git_http.Web.S</a></code></div><div class="doc"></div></div><div class="spec module" id="module-Client"><a href="#module-Client" class="anchor"></a><div class="def module"><code><span class="keyword">module </span><a href="Client/index.html">Client</a> : <a href="../index.html#module-type-CLIENT">CLIENT</a><span class="keyword"> with </span><span class="keyword">type </span><a href="../module-type-CLIENT/index.html#type-headers">headers</a><span class="keyword"> = </span><a href="Web/HTTP/index.html#type-headers">Web.HTTP.headers</a><span class="keyword"> and </span><span class="keyword">type </span><a href="../module-type-CLIENT/index.html#type-meth">meth</a><span class="keyword"> = </span><a href="Web/HTTP/index.html#type-meth">Web.HTTP.meth</a><span class="keyword"> and </span><span class="keyword">type </span><a href="../module-type-CLIENT/index.html#type-resp">resp</a><span class="keyword"> = </span><a href="Web/index.html#type-resp">Web.resp</a></code></div><div class="doc"></div></div><div class="spec module" id="module-Endpoint"><a href="#module-Endpoint" class="anchor"></a><div class="def module"><code><span class="keyword">module </span><a href="Endpoint/index.html">Endpoint</a> : <a href="../index.html#module-type-ENDPOINT">ENDPOINT</a><span class="keyword"> with </span><span class="keyword">type </span><a href="../module-type-ENDPOINT/index.html#type-t">t</a><span class="keyword"> = </span><a href="Client/index.html#type-endpoint">Client.endpoint</a><span class="keyword"> and </span><span class="keyword">type </span><a href="../module-type-ENDPOINT/index.html#type-headers">headers</a><span class="keyword"> = </span><a href="Client/index.html#type-headers">Client.headers</a></code></div><div class="doc"></div></div><div class="spec include"><div class="doc"></div><details open="open"><summary><span class="def"><code><span class="keyword">include </span><a href="../../../../git/Git/Sync/index.html#module-type-S">Git.Sync.S</a><span class="keyword"> with </span><span class="keyword">module </span><a href="../../../../git/Git/Sync/module-type-S/Endpoint/index.html">Endpoint</a> := <a href="index.html#module-Endpoint">Endpoint</a></code></span></summary><div class="spec module" id="module-Store"><a href="#module-Store" class="anchor"></a><div class="def module"><code><span class="keyword">module </span><a href="Store/index.html">Store</a> : <a href="../../../../git/Git__/Minimal/index.html#module-type-S">Git__.Minimal.S</a></code></div><div class="doc"></div></div><div class="spec module" id="module-Endpoint"><a href="#module-Endpoint" class="anchor"></a><div class="def module"><code><span class="keyword">module </span><a href="Endpoint/index.html">Endpoint</a> : <a href="../../../../git/Git/Sync/index.html#module-type-ENDPOINT">Git.Sync.ENDPOINT</a></code></div><div class="doc"></div></div><div class="spec type" id="type-error"><a href="#type-error" class="anchor"></a><div class="def type"><code><span class="keyword">type </span>error</code><code></code><code></code></div><div class="doc"></div></div><div class="spec val" id="val-pp_error"><a href="#val-pp_error" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>pp_error : <a href="index.html#type-error">error</a> Fmt.t</code></div><div class="doc"><p>Pretty-printer of <a href="index.html#type-error">error</a>.</p></div></div><div class="spec type" id="type-command"><a href="#type-command" class="anchor"></a><div class="def type"><code><span class="keyword">type </span>command</code><span class="keyword"> = </span><code>[ </code><table class="variant"><tr id="type-command.Create" class="anchored"><td class="def constructor"><a href="#type-command.Create" class="anchor"></a><code><span class="keyword">| </span></code><code>`Create<span class="keyword"> of </span><a href="Store/index.html#module-Hash">Store.Hash</a>.t<span class="keyword"> * </span><a href="Store/Reference/index.html#type-t">Store.Reference.t</a></code></td></tr><tr id="type-command.Delete" class="anchored"><td class="def constructor"><a href="#type-command.Delete" class="anchor"></a><code><span class="keyword">| </span></code><code>`Delete<span class="keyword"> of </span><a href="Store/index.html#module-Hash">Store.Hash</a>.t<span class="keyword"> * </span><a href="Store/Reference/index.html#type-t">Store.Reference.t</a></code></td></tr><tr id="type-command.Update" class="anchored"><td class="def constructor"><a href="#type-command.Update" class="anchor"></a><code><span class="keyword">| </span></code><code>`Update<span class="keyword"> of </span><a href="Store/index.html#module-Hash">Store.Hash</a>.t<span class="keyword"> * </span><a href="Store/index.html#module-Hash">Store.Hash</a>.t<span class="keyword"> * </span><a href="Store/Reference/index.html#type-t">Store.Reference.t</a></code></td></tr></table><code> ]</code><code></code></div><div class="doc"><p>A push command to interact with the server.</p></div></div><div class="spec val" id="val-pp_command"><a href="#val-pp_command" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>pp_command : <a href="index.html#type-command">command</a> Fmt.t</code></div><div class="doc"><p>Pretty-printer of <a href="index.html#type-command">command</a>.</p></div></div><div class="spec val" id="val-push"><a href="#val-push" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>push : <a href="Store/index.html#type-t">Store.t</a> <span class="keyword">&#8209;&gt;</span> push:((<a href="Store/index.html#module-Hash">Store.Hash</a>.t<span class="keyword"> * </span><a href="Store/Reference/index.html#type-t">Store.Reference.t</a><span class="keyword"> * </span>bool) list <span class="keyword">&#8209;&gt;</span> (<a href="Store/index.html#module-Hash">Store.Hash</a>.t list<span class="keyword"> * </span><a href="index.html#type-command">command</a> list) Lwt.t) <span class="keyword">&#8209;&gt;</span> ?&#8288;capabilities:<a href="../../../../git/Git/Capability/index.html#type-t">Git.Capability.t</a> list <span class="keyword">&#8209;&gt;</span> <a href="Endpoint/index.html#type-t">Endpoint.t</a> <span class="keyword">&#8209;&gt;</span> ((<a href="Store/Reference/index.html#type-t">Store.Reference.t</a>, <a href="Store/Reference/index.html#type-t">Store.Reference.t</a><span class="keyword"> * </span>string) Stdlib.result list, <a href="index.html#type-error">error</a>) Stdlib.result Lwt.t</code></div><div class="doc"></div></div><div class="spec val" id="val-ls"><a href="#val-ls" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>ls : <a href="Store/index.html#type-t">Store.t</a> <span class="keyword">&#8209;&gt;</span> ?&#8288;capabilities:<a href="../../../../git/Git/Capability/index.html#type-t">Git.Capability.t</a> list <span class="keyword">&#8209;&gt;</span> <a href="Endpoint/index.html#type-t">Endpoint.t</a> <span class="keyword">&#8209;&gt;</span> ((<a href="Store/index.html#module-Hash">Store.Hash</a>.t<span class="keyword"> * </span><a href="Store/Reference/index.html#type-t">Store.Reference.t</a><span class="keyword"> * </span>bool) list, <a href="index.html#type-error">error</a>) Stdlib.result Lwt.t</code></div><div class="doc"></div></div><div class="spec val" id="val-fetch"><a href="#val-fetch" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>fetch : <a href="Store/index.html#type-t">Store.t</a> <span class="keyword">&#8209;&gt;</span> ?&#8288;shallow:<a href="Store/index.html#module-Hash">Store.Hash</a>.t list <span class="keyword">&#8209;&gt;</span> ?&#8288;capabilities:<a href="../../../../git/Git/Capability/index.html#type-t">Git.Capability.t</a> list <span class="keyword">&#8209;&gt;</span> notify:(<a href="Store/index.html#module-Hash">Store.Hash</a>.t <a href="../../../../git/Git/Sync/index.html#type-shallow_update">Git.Sync.shallow_update</a> <span class="keyword">&#8209;&gt;</span> unit Lwt.t) <span class="keyword">&#8209;&gt;</span> negociate:((<a href="Store/index.html#module-Hash">Store.Hash</a>.t <a href="../../../../git/Git/Sync/index.html#type-acks">Git.Sync.acks</a> <span class="keyword">&#8209;&gt;</span> <span class="type-var">'state</span> <span class="keyword">&#8209;&gt;</span> ([ `Ready | `Done | `Again of <a href="Store/Hash/index.html#module-Set">Store.Hash.Set</a>.t ]<span class="keyword"> * </span><span class="type-var">'state</span>) Lwt.t)<span class="keyword"> * </span><span class="type-var">'state</span>) <span class="keyword">&#8209;&gt;</span> have:<a href="Store/Hash/index.html#module-Set">Store.Hash.Set</a>.t <span class="keyword">&#8209;&gt;</span> want:((<a href="Store/index.html#module-Hash">Store.Hash</a>.t<span class="keyword"> * </span><a href="Store/Reference/index.html#type-t">Store.Reference.t</a><span class="keyword"> * </span>bool) list <span class="keyword">&#8209;&gt;</span> (<a href="Store/Reference/index.html#type-t">Store.Reference.t</a><span class="keyword"> * </span><a href="Store/index.html#module-Hash">Store.Hash</a>.t) list Lwt.t) <span class="keyword">&#8209;&gt;</span> ?&#8288;deepen:[ `Depth of int | `Timestamp of int64 | `Ref of <a href="../../../../git/Git/Reference/index.html#type-t">Git.Reference.t</a> ] <span class="keyword">&#8209;&gt;</span> <a href="Endpoint/index.html#type-t">Endpoint.t</a> <span class="keyword">&#8209;&gt;</span> ((<a href="Store/Reference/index.html#type-t">Store.Reference.t</a><span class="keyword"> * </span><a href="Store/index.html#module-Hash">Store.Hash</a>.t) list<span class="keyword"> * </span>int, <a href="index.html#type-error">error</a>) Stdlib.result Lwt.t</code></div><div class="doc"></div></div><div class="spec val" id="val-fetch_some"><a href="#val-fetch_some" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>fetch_some : <a href="Store/index.html#type-t">Store.t</a> <span class="keyword">&#8209;&gt;</span> ?&#8288;capabilities:<a href="../../../../git/Git/Capability/index.html#type-t">Git.Capability.t</a> list <span class="keyword">&#8209;&gt;</span> references:<a href="Store/Reference/index.html#type-t">Store.Reference.t</a> list <a href="Store/Reference/index.html#module-Map">Store.Reference.Map</a>.t <span class="keyword">&#8209;&gt;</span> <a href="Endpoint/index.html#type-t">Endpoint.t</a> <span class="keyword">&#8209;&gt;</span> (<a href="Store/index.html#module-Hash">Store.Hash</a>.t <a href="Store/Reference/index.html#module-Map">Store.Reference.Map</a>.t<span class="keyword"> * </span><a href="Store/Reference/index.html#type-t">Store.Reference.t</a> list <a href="Store/Reference/index.html#module-Map">Store.Reference.Map</a>.t, <a href="index.html#type-error">error</a>) Stdlib.result Lwt.t</code></div><div class="doc"><p><code class="code">fetch_some git ?capabilities ~references repository</code> will fetch some
remote references specified by <code class="code">references</code>.</p><p><code class="code">references</code> is a map which: </p><ul><li>the key is the <b>remote</b> reference.</li><li>the value is a list of <b>local</b> references - which may not exist
yet.</li></ul><p>Then, the function will try to download all of these remote references
and returns 2 maps:</p><ul><li><p>the first map contains all local references updated by the new
hash. This new hash is come from the server as the downloaded remote
reference asked by the client by <code class="code">references</code>. Then, from associated
local references with remote references, we updated them with the
associated hash.</p><p>For example, if <code class="code">references</code> is: </p><pre><code class="code">{ &quot;refs/heads/master&quot;: [
      &quot;refs/remotes/origin/master&quot; ; &quot;refs/heads/master&quot; ] }</code></pre><p>We will update (or create) &quot;refs/remotes/origin/master&quot; and
&quot;refs/heads/master&quot; with the new hash downloaded from the remote
reference &quot;refs/heads/master&quot; only if it's necessary (only if we did not
find the hash referenced by &quot;refs/heads/master&quot; in the local store).</p></li><li><p>the second map is a <b>subset</b> of <code class="code">references</code> which contains all
binder of:</p><ul><li>remote references which does not exist on the server side.</li><li>remote references which references to an already existing in the local
store hash.</li></ul></li></ul><p>The client should not put the same local reference as a value of some
remote references. The client can define non-existing remote references
(then, they appear on the second map). The client can want to set
non-existing local references - we will create them.</p><p>If the processus encountered an error when it updates references, it
leaves but, it did partially some update on some local references.</p></div></div><div class="spec val" id="val-fetch_all"><a href="#val-fetch_all" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>fetch_all : <a href="Store/index.html#type-t">Store.t</a> <span class="keyword">&#8209;&gt;</span> ?&#8288;capabilities:<a href="../../../../git/Git/Capability/index.html#type-t">Git.Capability.t</a> list <span class="keyword">&#8209;&gt;</span> references:<a href="Store/Reference/index.html#type-t">Store.Reference.t</a> list <a href="Store/Reference/index.html#module-Map">Store.Reference.Map</a>.t <span class="keyword">&#8209;&gt;</span> <a href="Endpoint/index.html#type-t">Endpoint.t</a> <span class="keyword">&#8209;&gt;</span> (<a href="Store/index.html#module-Hash">Store.Hash</a>.t <a href="Store/Reference/index.html#module-Map">Store.Reference.Map</a>.t<span class="keyword"> * </span><a href="Store/Reference/index.html#type-t">Store.Reference.t</a> list <a href="Store/Reference/index.html#module-Map">Store.Reference.Map</a>.t<span class="keyword"> * </span><a href="Store/index.html#module-Hash">Store.Hash</a>.t <a href="Store/Reference/index.html#module-Map">Store.Reference.Map</a>.t, <a href="index.html#type-error">error</a>) Stdlib.result Lwt.t</code></div><div class="doc"><p><code class="code">fetch_all git ?capabilities ~references repository</code> has the same
semantic than <a href="index.html#val-fetch_some">fetch_some</a> for any remote references found on
<code class="code">references</code>. However, <code class="code">fetch all</code> will download all remote references
available on the server (and whose hash is not available on the local
store). If these remote references are not associated with some local
references, we return a third map which contains these remote references
binded with the new hash downloaded.</p><p>We <b>don't</b> notice any non-downloaded remote references not found on the
<code class="code">references</code> map and whose hash already exists on the local store.</p><p>Then, the client can bind these new hashes with specific local references
or just give up.</p></div></div><div class="spec val" id="val-fetch_one"><a href="#val-fetch_one" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>fetch_one : <a href="Store/index.html#type-t">Store.t</a> <span class="keyword">&#8209;&gt;</span> ?&#8288;capabilities:<a href="../../../../git/Git/Capability/index.html#type-t">Git.Capability.t</a> list <span class="keyword">&#8209;&gt;</span> reference:(<a href="Store/Reference/index.html#type-t">Store.Reference.t</a><span class="keyword"> * </span><a href="Store/Reference/index.html#type-t">Store.Reference.t</a> list) <span class="keyword">&#8209;&gt;</span> <a href="Endpoint/index.html#type-t">Endpoint.t</a> <span class="keyword">&#8209;&gt;</span> ([ `AlreadySync | `Sync of <a href="Store/index.html#module-Hash">Store.Hash</a>.t <a href="Store/Reference/index.html#module-Map">Store.Reference.Map</a>.t ], <a href="index.html#type-error">error</a>) Stdlib.result Lwt.t</code></div><div class="doc"><p><code class="code">fetch_one git ?capabilities ~reference repository</code> is a specific call of
<a href="index.html#val-fetch_some">fetch_some</a> with only one reference. Then, it retuns:</p><ul><li><code class="code">`AlreadySync</code> if the hash of the requested reference already
exists on the local store</li><li><code class="code">`Sync updated</code> if we downloaded <code class="code">new_hash</code>
and set <code class="code">local_ref</code> with this new hash.</li></ul></div></div><div class="spec val" id="val-clone"><a href="#val-clone" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>clone : <a href="Store/index.html#type-t">Store.t</a> <span class="keyword">&#8209;&gt;</span> ?&#8288;capabilities:<a href="../../../../git/Git/Capability/index.html#type-t">Git.Capability.t</a> list <span class="keyword">&#8209;&gt;</span> reference:(<a href="Store/Reference/index.html#type-t">Store.Reference.t</a><span class="keyword"> * </span><a href="Store/Reference/index.html#type-t">Store.Reference.t</a>) <span class="keyword">&#8209;&gt;</span> <a href="Endpoint/index.html#type-t">Endpoint.t</a> <span class="keyword">&#8209;&gt;</span> (unit, <a href="index.html#type-error">error</a>) Stdlib.result Lwt.t</code></div><div class="doc"></div></div><div class="spec val" id="val-update_and_create"><a href="#val-update_and_create" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>update_and_create : <a href="Store/index.html#type-t">Store.t</a> <span class="keyword">&#8209;&gt;</span> ?&#8288;capabilities:<a href="../../../../git/Git/Capability/index.html#type-t">Git.Capability.t</a> list <span class="keyword">&#8209;&gt;</span> references:<a href="Store/Reference/index.html#type-t">Store.Reference.t</a> list <a href="Store/Reference/index.html#module-Map">Store.Reference.Map</a>.t <span class="keyword">&#8209;&gt;</span> <a href="Endpoint/index.html#type-t">Endpoint.t</a> <span class="keyword">&#8209;&gt;</span> ((<a href="Store/Reference/index.html#type-t">Store.Reference.t</a>, <a href="Store/Reference/index.html#type-t">Store.Reference.t</a><span class="keyword"> * </span>string) Stdlib.result list, <a href="index.html#type-error">error</a>) Stdlib.result Lwt.t</code></div><div class="doc"><p>As <a href="index.html#val-fetch_some">fetch_some</a>, <code class="code">update git ?capabilities ~references repository</code> is
the other side of the communication with a Git server and update and
create remote references when it uploads local hashes.</p><p><code class="code">reference</code> is a map which: </p><ul><li>the key is the <b>local</b> reference.</li><li>the value is a list of <b>remote</b> references - which may not exist
yet.</li></ul><p>Then, the function will try to upload all of these local references to
the binded remote references. If binded remote reference does not exist
on the server, we ask to the server to create and set it to the local
hash.</p><p>For each update action, we check if the local store has the remote hash.
In other case, we miss this action - that means, the local store is not
synchronized with the server (and the client probably needs to
<a href="index.html#val-fetch_some">fetch_some</a> before).</p><p>Then, it returns a list of results. The <code class="code">Ok</code> case with the remote
reference which the server updated correctly and the <code class="code">Error</code> case with
the remote reference which the server encountered an error with a
description of this error.</p><p>At this final stage, the function does not encountered any error during
the commmunication - if it's the case, we did not do any modification on
the server and return an <a href="index.html#type-error">error</a>.</p></div></div></details></div></body></html>